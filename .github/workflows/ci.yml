name: tests

on:
  push:
  pull_request:
    types: [opened, reopened, review_requested, synchronize]
  workflow_dispatch:
  # Run tests 10:00 PM (JST) every day
  schedule:
    - cron: '0 13 * * *'

env:
  COBOL4J_LIB_DIR: /usr/lib/opensourcecobol4j
  COBOL4J_LIBCOBJ_JAR_PATH: /usr/lib/opensourcecobol4j/libcobj.jar
  OCESQL4J_LIB_DIR: /usr/lib/Open-COBOL-ESQL-4j
  OCESQL4J_OCESQL4J_JAR_PATH: /usr/lib/Open-COBOL-ESQL-4j/ocesql4j.jar
  CLASSPATH: ":/usr/lib/Open-COBOL-ESQL-4j/ocesql4j.jar"


permissions:
  contents: read

jobs:
  Open-COBOL-ESQL-4j-tests:
    strategy:
      matrix:
        os: ["ubuntu:22.04", "almalinux:9"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.os }}
    
    services:
      # Start PostgreSQL 9.6 server
      postgres9_6:
        image: postgres:9.6
        ports: 
          - 5432:5432
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: main_user
          POSTGRES_DB: testdb
          POSTGRES_HOST_AUTH_METHOD: 'trust'
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Start PostgreSQL 15 server
      postgres15:
        image: postgres:15
        ports: 
          - 5433:5432
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: main_user
          POSTGRES_DB: testdb
          POSTGRES_HOST_AUTH_METHOD: 'trust'
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # Install dependencies (Ubuntu 22.04)
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: Install dependencies on Ubuntu 22.04
        if: matrix.os == 'ubuntu:22.04'
        run: |
          apt update -y
          apt install -y build-essential bison flex gettext texinfo automake autoconf curl

      # Install dependencies (Almalinux 9)
      - name: Install dependencies on AlmaLinux 9
        if: matrix.os == 'almalinux:9'
        run: |
          dnf -y update
          dnf install -y gcc gcc-c++ make bison flex automake autoconf diffutils gettext

      # Setup JDK
      - name: Setup JDK
        uses: actions/setup-java@9704b39bf258b59bc04b50fa2dd55e9ed76b47a8 # v4.1.0
        with:
          distribution: zulu
          java-version: 11

      # Setup sbt
      - name: Setup sbt
        uses: olafurpg/setup-scala@3d6c824bc1a3ffa8bde6bf8b4865cb4387e3ac31 # v11
        with:
          java-version: zulu@1.11

      # Checkout
      - name: Checkout Open-COBOL-ESQL-4j
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
          
      # Checkout opensource COBOL 4J
      - name: Checkout opensourcecobol 4J
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: opensourcecobol/opensourcecobol4j
          path: opensourcecobol4j
      
      # Install opensource COBOL 4J
      - name: Install opensource COBOL 4J
        working-directory: opensourcecobol4j
        run: |
          ./configure --prefix=/usr/ CFLAGS='-Werror'
          make
          make install

      # Build and Install Open COBOL ESQL 4J
      - name: Install Open COBOL ESQL 4J
        run: |
          cp $COBOL4J_LIBCOBJ_JAR_PATH dblibj/lib
          sh configure --prefix=/usr/ CFLAGS='-Werror'
          make
          make install

      # Run Autotest for PostgreSQL 9.6
      - name: Run tests for PostgreSQL 9.6
        working-directory: tests
        run: |
          cp ../.github/workflows/db-settings/embed_db_info_postgresql_9.6.sh embed_db_info.sh
          make test

      # Run Autotest for PostgreSQL 15
      - name: Run tests for PostgreSQL 15
        working-directory: tests
        run: |
          cp ../.github/workflows/db-settings/embed_db_info_postgresql_15.sh embed_db_info.sh
          make test